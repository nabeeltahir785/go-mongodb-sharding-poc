# Envoy L7 Load Balancer Configuration
#
# THE L7 PROBLEM: Standard K8s Services operate at L4 (TCP). Because gRPC
# multiplexes all RPCs over a single HTTP/2 connection, a L4 load balancer
# "sticks" the entire connection to one backend pod. All RPCs go to one pod.
#
# THE FIX: Envoy operates at L7 (HTTP/2 frame level). It inspects each gRPC
# RPC within the multiplexed connection and distributes them individually
# across backend pods using ROUND_ROBIN.

apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-config
  namespace: sharding-poc
  labels:
    app: sharding-poc
    component: envoy
data:
  envoy.yaml: |
    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9901

    static_resources:
      listeners:
        # L7 gRPC listener — external clients connect here
        - name: grpc_listener
          address:
            socket_address:
              address: 0.0.0.0
              port_value: 8443
          filter_chains:
            - filters:
                - name: envoy.filters.network.http_connection_manager
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                    stat_prefix: grpc_ingress
                    codec_type: AUTO
                    # Access logging for observability
                    access_log:
                      - name: envoy.access_loggers.stdout
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                          log_format:
                            text_format: "[envoy] %DOWNSTREAM_REMOTE_ADDRESS% -> %UPSTREAM_HOST% %REQ(:method)% %REQ(:path)% %RESPONSE_CODE% %DURATION%ms\n"
                    route_config:
                      name: grpc_route
                      virtual_hosts:
                        - name: grpc_backend
                          domains: ["*"]
                          routes:
                            - match:
                                prefix: "/"
                                grpc: {}
                              route:
                                cluster: grpc_servers
                                timeout: 60s
                                max_stream_duration:
                                  max_stream_duration: 300s
                    http_filters:
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      clusters:
        # gRPC server cluster — Envoy discovers pods via headless service DNS
        - name: grpc_servers
          connect_timeout: 5s
          type: STRICT_DNS
          dns_lookup_family: V4_ONLY
          lb_policy: ROUND_ROBIN

          # HTTP/2 upstream — required for gRPC
          typed_extension_protocol_options:
            envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
              "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
              explicit_http_config:
                http2_protocol_options:
                  max_concurrent_streams: 5000
                  initial_stream_window_size: 1048576
                  initial_connection_window_size: 2097152

          load_assignment:
            cluster_name: grpc_servers
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          # Headless service DNS — resolves to all pod IPs
                          address: grpc-server-headless.sharding-poc.svc.cluster.local
                          port_value: 50051

          # Health checking via gRPC health protocol
          health_checks:
            - timeout: 5s
              interval: 10s
              unhealthy_threshold: 3
              healthy_threshold: 2
              grpc_health_check: {}

          # Circuit breaker tuning for high throughput
          circuit_breakers:
            thresholds:
              - priority: DEFAULT
                max_connections: 1024
                max_pending_requests: 1024
                max_requests: 5000
                max_retries: 3
